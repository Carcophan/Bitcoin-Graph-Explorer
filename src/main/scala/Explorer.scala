import java.io.File
import actions._
import util._
import core._

/**
 * Created with IntelliJ IDEA.
 * User: yzark
 * Date: 11/19/1
 * Time: 12:36 PM
 * To change this template use File | Settings | File Templates.
 */
object Explorer extends App {
  args.toList match{

    case "populate"::rest             =>
      initializeReaderTables
      PopulateBlockReader
      createIndexes
      closure(PopulateBlockReader.processedBlocks)
      initializeStatsTables
      makeNewStats

    case "resume"::rest =>
      import sys.process._

      while (new java.io.File("/root/Bitcoin-Graph-Explorer/blockchain/lock").exists)
      {
        "/root/Bitcoin-Graph-Explorer/scripts/getblocklist.sh".! // TODO: replace this script by a scala function entirely!
        val cmd = Seq("cat", "/root/.bitcoin/blocklist.txt") #| Seq( "wc", "-l")
        val from = blockCount
        val to = Integer.parseInt(cmd.lines.head, 10)
        println("From " + from + " to " + to)
        if (to > from)
        {
          println("Reading blocks from " + (from-1) + " to " +(to-1))
          resume
          println("DEBUG: making new stats")
          makeNewStats
        }
        else
        {
          println("waiting for new blocks")
          Thread sleep 60000
        }
      }
      println("process stopped")


    case _=> println("""
      Available commands:

       populate: create the database movements with movements and closures.
       resume: update the database generated by populate with new incoming data.

    """)
  }

  def closure(blockList:Vector[Int]) = {
    initializeClosureTables
    new PopulateClosure(blockList)
    createAddressIndexes

  }

  def resume = {
    new ResumeClosure((new ResumeBlockReader).processedBlocks)
  }

  def makeNewStats = {
    createBalanceTables
    insertStatistics
    insertRichestAddresses
    insertRichestClosures
  }
}
